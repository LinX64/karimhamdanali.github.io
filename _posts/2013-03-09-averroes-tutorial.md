---
layout: post
title: Analyzing DaCapo and SPEC JVM with averroes - Tutorial
date:   2013-03-09 01:41:00
permalink: /research/averroes-tutorial
group: research
---

This page steps through the process to download and run Averroes to analyze the programs from the 
<a href="http://sourceforge.net/projects/dacapobench/files/archive/2006-10-MR2/" target="_blank">DaCapo-2006-10MR2</a> 
and the <a href="http://www.spec.org/jvm98/" target="_blank">SPEC JVM98</a> benchmarks. I will refer to all these 
programs by the word "benchmarks" throughout the rest of this tutorial.

## Prerequisites ##
You can either:

1. download <a href="https://www.dropbox.com/s/azz3yd7f3kgd4fu/averroes-home.tar.gz?dl=1">averroes-home.tar.gz</a> 
(the complete archive of files needed for this tutorial) on a machine that runs Java 5.0 or above (both JDK and JRE are 
expected to be installed).
* download <a href="http://www.dropbox.com/s/vbj5ha1s5sx6z6p/ECOOP13.ova" target="_blank">this</a> virtual machine that 
comes with Java pre-installed and contains `averroes-home.tar.gz` on the desktop. Both the user name and the password 
for the administrator account on the virtual machine are "aec", the machine name is "ecoop13".

After the download is complete, extract `averroes-home.tar.gz` to any directory you want.

## Contents of `averroes-home` ##
The directory `averroes-home` should now contain the following artifacts:

* <a href="https://www.dropbox.com/sh/qbjr788ug9o7o13/AAByJ0otJsB12Suq9H0NOwbIa?dl=1">benchmarks/</a>: a directory that contain the JAR files for the benchmarks.
* <a href="https://www.dropbox.com/sh/k6qu407jc2uexbk/AAAl_PVcZ9GmIxxx63HH_835a?dl=1">callgraphs/cgc-call-graphs</a>: a directory that contains the call graphs generated by <a href="{{ "/research/cgc/" | prepend: site.baseurl }}">cgc</a> for the benchmarks.
* <a href="https://www.dropbox.com/sh/y5ad3i9llzk9p65/AADDE5vWHdeSO5vBbVLHMoiHa?dl=1">callgraphs/doop-averroes-call-graphs</a>: 
a directory that contains the static call graphs generated by Doop<sub>Averroes</sub> (that is Doop using the 
placeholder library generated by Averroes instead of the original library code) for the benchmarks. Running Doop itself 
requires a license for LogicBlox as it depends on it for computing the call graph relations.
* <a href="https://www.dropbox.com/sh/z5r882i4sqbdktw/AAApk2IV_WcSrUdUplZL2a69a?dl=1">callgraphs/doop-call-graphs</a>: 
a directory that contains the static call graphs generated by <a href="http://doop.program-analysis.org" target="_blank">Doop</a> for the benchmarks.
* <a href="https://www.dropbox.com/sh/c6ym92nkkznbby4/AABSMl_-bQY-4YP8uyJcNggua?dl=1">callgraphs/dynamic-call-graphs</a>: 
a directory that contains the dynamic call graphs generated by <a href="http://www.sable.mcgill.ca/starj/" target="_blank">*J</a> for the benchmarks.
* <a href="https://www.dropbox.com/sh/o8imxkhk3pxddgy/AAAzH33YXNuN0VgG9zxsIWv0a?dl=1">callgraphs/spark-call-graphs</a>: 
a directory that contains the static call graphs generated by 
<a href="http://www.sable.mcgill.ca/publications/papers/#cc2003-1" target="_blank">Spark</a> from the 
<a href="http://www.sable.mcgill.ca/soot/" target="_blank">Soot</a> framework for the benchmarks.
* <a href="https://www.dropbox.com/s/vvzwymzghlypoz5/rt-1.4.2_11.jar?dl=1">jre/rt-1.4.2_11.jar</a>: 
the default JRE that Averroes uses when generating the placeholder library for any program.
* <a href="{{ "/resources/averroes/tutorial/properties" | prepend: site.baseurl }}" target="_blank">properties/</a>: a directory that 
contains Averroes properties files for the benchmarks. Each file contains the properties below. A sample properties file with more documentation is available <a href="{{ "/resources/averroes/tutorial/properties/averroes.properties.sample" | prepend: site.baseurl }}">here</a>. 

Property | Description | Example
:--------|:------------|-------:
*application_includes* | a list of the application classes that Averroes should consider | dacapo.antlr.\*:antlr.\*\*
*main_class* | the main class that runs if the input program executes | dacapo.antlr.Main2
*input_jar_files* | a list of input JAR files | dacapo/antlr.jar
*library_jar_files* | a list of library JAR files | dacapo/antlr-deps.jar
*dynamic_classes_file* | a file with a list of classes that may be dynamically loaded | dacapo/antlr.dyn
*tamiflex_facts_file* | a file that reflection facts in the TamiFlex format | dacapo/antlr.tfx
*output_dir* | the directory to which Averroes outputs its artifacts | output
*jre* | the Java runtime environment Averroes should use | jre/rt-1.4.2_11.jar


* <a href="{{ "/resources/averroes/tutorial/averroes" | prepend: site.baseurl }}">averroes</a>: a bash script that runs 
Averroes on an input benchmark to generate its placeholder library.
* <a href="{{ "/resources/averroes/tutorial/averroes-all" | prepend: site.baseurl }}">averroes-all</a>: a bash script that runs <a href="{{ "/resources/averroes/tutorial/averroes" | prepend: site.baseurl }}">averroes</a> over all the benchmarks.
* <a href="https://www.dropbox.com/s/tltgmzrrmalr0y7/averroes.jar?dl=1">averroes.jar</a>: the main 
runnable JAR for Averroes. This program is the *JAR factory* that will create the placeholder library JAR file for any 
input program.
* <a href="https://www.dropbox.com/s/z679b8fhckg9zu0/cginfo.jar?dl=1">cginfo.jar</a>: a utility JAR that prints out call graph information. 
* <a href="{{ "/resources/averroes/tutorial/spark-averroes" | prepend: site.baseurl }}">spark-averroes</a>: a bash script that runs Spark<sub>Averroes</sub> on an input benchmark to generate its call graph.
* <a href="{{ "/resources/averroes/tutorial/spark-averroes-all" | prepend: site.baseurl }}">spark-averroes-all</a>: a bash script that runs <a href="{{ "/resources/averroes/tutorial/spark-averroes" | prepend: site.baseurl }}">spark-averroes</a> over all the benchmarks.
* <a href="https://www.dropbox.com/s/205h5fj36fpvdax/spark-averroes.jar?dl=1">spark-averroes.jar</a>: a runnable JAR for that runs Spark using the placeholder library generated by Averroes instead of the original library code.
* <a href="{{ "/resources/averroes/tutorial/stats" | prepend: site.baseurl }}">stats</a>: a bash script that generates the statistics of comparing the call graphs generated by Averroes-based tools to the original tools.
* <a href="{{ "/resources/averroes/tutorial/stats-all" | prepend: site.baseurl }}">stats-all</a>: a bash script that runs <a href="{{ "/resources/averroes/tutorial/stats" | prepend: site.baseurl }}" target="_blank">stats</a> over all the benchmarks.
* <a href="https://www.dropbox.com/s/6ez3u4wu27toc33/stats.jar?dl=1">stats.jar</a>: a runnable JAR for that runs the statistics generator of Averroes on a given benchmark.

## Generating Placeholder Libraries ##
After extracting `averroes-home.tar.gz`, run the following commands on your terminal:

``` bash
$ cd averroes-home/
$ ./averroes-all
```
This will make Averroes process all the benchmarks and generate the placeholder libraries for them. The JAR files 
generated by Averroes for each benchmark are copied from the output directory to the directory `averroes-home/benchmarks-averroes`. 
In that directory, there will be three JAR files for each benchmark:

* &lt;benchmark&gt;-placeholder-lib.jar: the placeholder library generated by Averroes.
* &lt;benchmark&gt;-organized-app.jar: the original application part of the benchmark as is (i.e., not altered by Averroes in any way).
* &lt;benchmark&gt;-organized-lib.jar: the original library part of the benchmark as is (i.e., not altered by Averroes in any way).

To generate the call graph for a benchmark, you need to supply a whole-program analysis tool (e.g., Soot) with two JAR 
files: `<benchmark>-placeholder-lib.jar` and `<benchmark>-organized-app.jar`. If you are running Averroes on 
your own program, these correspond to: `organizedApplication.jar` and `placeholderLibrary.jar`, respectively, 
generated in the output directory of Averroes.

## Generating the Call graphs ##
The call graphs generated by cgc, Spark, Doop, and Doop<sub>Averroes</sub> are available under the 
`averroes-home/callgraphs` directory for convenience. At the `averroes-home` directory, run the following command on 
your terminal to be able to generate the call graphs from Spark<sub>Averroes</sub> using the placeholder libraries:

``` bash
$ ./spark-averroes-all
```

When the script finishes execution, the resulting call graphs will be available under the directory 
`averroes-home/callgraphs/spark-averroes-call-graphs`. Each benchmark will have a directory that contains three files:

* &lt;benchmark&gt;-gc.stats: the verbose garbage collection log while running Spark<sub>Averroes</sub>. The 
information in that file is used to evaluate the memory consumption of Averroes-based tools.
* &lt;benchmark&gt;-sparkAverroes.stats: the output from Spark.
* sparkAverroes.gxl: the generated call graph in GXL format.

## Generating the Statistics ##
To compare all the call graphs for the benchmarks, run the following command on your terminal at the `averroes-home` directory:

``` bash
$ ./stats-all
```
When the script finishes execution, each benchmark will have a directory under 
`averroes-home/callgraphs/comparisons-call-graphs`, each containing the following files:

* &lt;benchmark&gt;-comparisons.stats: the statistics we use to evaluate Averroes. That's basically the result of 
comparing the soundness of Averroes vs the dynamic call graphs, and the precision vs the call graphs from Doop, Spark, and CGC.
* dynamic-sparkAverroes.gxl: the result of evaluating the soundness of Spark<sub>Averroes</sub> compared to the dynamic call graph.
* dynamic-doopAverroes.gxl: the result of evaluating the soundness of Doop<sub>Averroes</sub> compared to the dynamic call graph.
* spark-sparkAverroes.gxl: the result of evaluating the precision of Spark<sub>Averroes</sub> compared to Spark.
* doop-doopAverroes.gxl: the result of evaluating the precision of Doop<sub>Averroes</sub> compared to Doop.
* cgc-doopAverroes.gxl: the result of evaluating the soundness of Doop<sub>Averroes</sub> compared to CGC.
* doopAverroes-cgc.gxl: the result of evaluating the precision of Doop<sub>Averroes</sub> compared to CGC.

Each comparison call graph of the above is comprised of two call graphs that has the following naming convention:

* &lt;graph&gt;_app.gxl: edges originating from application methods.
* &lt;graph&gt;_lib.gxl: edges originating from the library (i.e., library call backs).

## Call Graph Info ##
The `averroes-home` directory contains a utility JAR called `cginfo.jar` that can print out information of any call 
graph that is used throughout this tutorial. You can use it as follows:

``` bash
$ java -jar cginfo.jar [options] &lt;graph&gt;.gxl
where options can be any combination of the following:
	-e : print entry points
  	-a2a : print application to application edges
  	-a2l : print application to library edges
  	-l2a : print library to application edges
```